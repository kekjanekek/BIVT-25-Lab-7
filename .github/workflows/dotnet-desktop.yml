name: .NET Tests & Auto-commit

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:

  check-target:
    runs-on: ubuntu-latest
    outputs:
      pr_valid: ${{ steps.check.outputs.pr_valid }}
    steps:
      - name: üö´ –ü—Ä–æ–≤–µ—Ä–∫–∞ PR –≤ main
        id: check
        shell: bash
        run: |
          PR_BASE="${{ github.event.pull_request.base.ref }}"
          echo "Base branch: $PR_BASE"
          if [ "$PR_BASE" = "main" ]; then
            echo "‚ùå –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞–±–æ—Ç—É –≤ main –≤–µ—Ç–∫—É."
            echo "pr_valid=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ PR –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤ '$PR_BASE', –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã."
            echo "pr_valid=true" >> $GITHUB_OUTPUT
          fi

  tests:
    name: Run test
    runs-on: windows-latest
    needs: check-target
    if: |
      (github.event_name == 'pull_request' && needs.check-target.outputs.pr_valid == 'true') ||
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        configuration: [Debug]

    steps:
      - name: Checkout code safely
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Install .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v2

      - name: Restore
        run: dotnet restore Lab7/Lab7.sln

      - name: Build
        run: dotnet build Lab7/Lab7.sln --configuration ${{ matrix.configuration }} --no-restore

      - name: Run tests (league cascade)
        id: cascade
        shell: pwsh
        env:
          CFG: ${{ matrix.configuration }}
        run: |
          $proj = "Lab7test/Lab7test.csproj"
          Write-Host "Building test project..."
          dotnet build $proj -c $Env:CFG
      
          $dll = Join-Path $PWD "Lab7test\bin\$Env:CFG\net8.0\Lab7test.dll"
          if (-not (Test-Path $dll)) {
            Write-Error "DLL –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $dll"
            exit 1
          }
      
          $leagues = @{
            "Purple" = @("Task1","Task2","Task3","Task4","Task5")
            "Blue"   = @("Task1","Task2","Task3","Task4","Task5")
            "Green"  = @("Task1","Task2","Task3","Task4","Task5")
            "White"  = @("Task1","Task2","Task3","Task4","Task5")
          }
      
          foreach ($leagueName in $leagues.Keys) {
            Write-Host "–õ–∏–≥–∞: $leagueName"
            $allPassed = $true
      
            foreach ($cls in $leagues[$leagueName]) {
              $filter = "FullyQualifiedName~$leagueName.$cls"
              Write-Host "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∫–ª–∞—Å—Å–∞: $leagueName.$cls"
              dotnet vstest $dll --TestCaseFilter:"$filter" --Logger:"trx;LogFileName=test-$leagueName-$cls.trx"
      
              if ($LASTEXITCODE -ne 0) {
                Write-Host "‚ùå –¢–µ—Å—Ç $leagueName.$cls –Ω–µ –ø—Ä–æ—à—ë–ª."
                $allPassed = $false
              } else {
                Write-Host "‚úÖ –¢–µ—Å—Ç $leagueName.$cls –ø—Ä–æ—à—ë–ª."
              }
            }
      
            if ($allPassed) {
              Write-Host "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ª–∏–≥–∏ $leagueName –ø—Ä–æ—à–ª–∏! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Å–∫–∞–¥."
              exit 0
            } else {
              Write-Host "‚ö†Ô∏è –ù–µ –≤—Å–µ —Ç–µ—Å—Ç—ã –ª–∏–≥–∏ $leagueName –ø—Ä–æ—à–ª–∏. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ª–∏–≥–µ."
            }
          }
      
          Write-Host "‚ùå –ù–∏ –æ–¥–Ω–∞ –ª–∏–≥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ –ø—Ä–æ—à–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤."
          exit 1
          
      - name: Upload TRX
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trx-${{ matrix.configuration }}
          path: '**/test-*.trx'
